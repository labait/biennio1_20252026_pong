<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #1a1a2e;
            font-family: 'Courier New', monospace;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #scoreboard {
            display: flex;
            gap: 60px;
            font-size: 48px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .score {
            min-width: 60px;
            text-align: center;
        }

        #gameCanvas {
            border: 4px solid #4a4a6a;
            border-radius: 8px;
            cursor: none;
        }

        #startBtn {
            padding: 15px 40px;
            font-size: 20px;
            font-family: 'Courier New', monospace;
            background: #16213e;
            color: #fff;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #startBtn:hover {
            background: #1f4068;
            border-color: #7a7aaa;
            transform: scale(1.05);
        }

        #startBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .instructions {
            color: #6a6a8a;
            font-size: 14px;
            text-align: center;
        }

        .menu-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 40px;
            background: rgba(22, 33, 62, 0.5);
            border: 2px solid #4a4a6a;
            border-radius: 12px;
        }

        .menu-screen h2 {
            color: #fff;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .mode-buttons {
            display: flex;
            gap: 20px;
        }

        .mode-btn {
            padding: 20px 40px;
            font-size: 18px;
            font-family: 'Courier New', monospace;
            background: #16213e;
            color: #fff;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background: #1f4068;
            border-color: #7a7aaa;
            transform: scale(1.05);
        }

        .multiplayer-setup {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }

        .room-code-display {
            padding: 20px;
            background: #0f0f23;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            text-align: center;
        }

        .room-code-display .label {
            color: #6a6a8a;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .room-code-display .code {
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 3px;
        }

        input[type="text"] {
            padding: 15px;
            font-size: 18px;
            font-family: 'Courier New', monospace;
            background: #0f0f23;
            color: #fff;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            text-align: center;
            letter-spacing: 2px;
        }

        input[type="text"]::placeholder {
            color: #6a6a8a;
        }

        .status-message {
            color: #7a7aaa;
            font-size: 14px;
            text-align: center;
            min-height: 20px;
        }

        .hidden {
            display: none !important;
        }

        .back-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: transparent;
            color: #6a6a8a;
            border: 1px solid #4a4a6a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            color: #fff;
            border-color: #7a7aaa;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Menu principale: selezione modalità -->
        <div id="modeMenu" class="menu-screen">
            <h2>PONG</h2>
            <p class="instructions">Scegli la modalità di gioco</p>
            <div class="mode-buttons">
                <button class="mode-btn" id="vsAIBtn">VS COMPUTER</button>
                <button class="mode-btn" id="vsPlayerBtn">VS GIOCATORE</button>
            </div>
        </div>

        <!-- Menu multiplayer: crea/unisciti a partita -->
        <div id="multiplayerMenu" class="menu-screen hidden">
            <h2>MULTIPLAYER</h2>
            <div class="mode-buttons">
                <button class="mode-btn" id="hostBtn">CREA PARTITA</button>
                <button class="mode-btn" id="joinBtn">UNISCITI</button>
            </div>
            <button class="back-btn" id="backFromMulti">Indietro</button>
        </div>

        <!-- Schermata host: mostra codice -->
        <div id="hostScreen" class="menu-screen hidden">
            <h2>CREA PARTITA</h2>
            <div class="room-code-display">
                <div class="label">Condividi questo codice:</div>
                <div class="code" id="roomCode">-----</div>
            </div>
            <p class="status-message" id="hostStatus">In attesa dell'altro giocatore...</p>
            <button class="back-btn" id="backFromHost">Annulla</button>
        </div>

        <!-- Schermata join: inserisci codice -->
        <div id="joinScreen" class="menu-screen hidden">
            <h2>UNISCITI</h2>
            <div class="multiplayer-setup">
                <input type="text" id="codeInput" placeholder="INSERISCI CODICE" maxlength="9">
                <button class="mode-btn" id="connectBtn">CONNETTI</button>
            </div>
            <p class="status-message" id="joinStatus"></p>
            <button class="back-btn" id="backFromJoin">Indietro</button>
        </div>

        <!-- Schermata di gioco -->
        <div id="gameScreen" class="hidden">
            <div id="scoreboard">
                <span class="score" id="scoreLeft">0</span>
                <span>-</span>
                <span class="score" id="scoreRight">0</span>
            </div>
            <canvas id="gameCanvas" width="800" height="500"></canvas>
            <button id="startBtn">INIZIA</button>
            <p class="instructions" id="gameInstructions">Muovi il mouse su e giù per controllare la racchetta destra</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        // ========== RIFERIMENTI DOM ==========
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const scoreLeftEl = document.getElementById('scoreLeft');
        const scoreRightEl = document.getElementById('scoreRight');

        // Menu screens
        const modeMenu = document.getElementById('modeMenu');
        const multiplayerMenu = document.getElementById('multiplayerMenu');
        const hostScreen = document.getElementById('hostScreen');
        const joinScreen = document.getElementById('joinScreen');
        const gameScreen = document.getElementById('gameScreen');
        const gameInstructions = document.getElementById('gameInstructions');

        // Buttons
        const vsAIBtn = document.getElementById('vsAIBtn');
        const vsPlayerBtn = document.getElementById('vsPlayerBtn');
        const hostBtn = document.getElementById('hostBtn');
        const joinBtn = document.getElementById('joinBtn');
        const connectBtn = document.getElementById('connectBtn');
        const backFromMulti = document.getElementById('backFromMulti');
        const backFromHost = document.getElementById('backFromHost');
        const backFromJoin = document.getElementById('backFromJoin');

        // Multiplayer elements
        const roomCodeEl = document.getElementById('roomCode');
        const codeInput = document.getElementById('codeInput');
        const hostStatus = document.getElementById('hostStatus');
        const joinStatus = document.getElementById('joinStatus');

        // Carica i suoni dalla cartella sound
        const whistleSound = new Audio('sound/whistle.mp3');
        const pongSound = new Audio('sound/pong.mp3');
        const trumpetSound = new Audio('sound/trumpet.mp3');

        // ========== STATO DEL GIOCO ==========
        let gameMode = null; // 'ai' o 'multiplayer'
        let isHost = false;
        let peer = null;
        let connection = null;
        let myPaddleSide = null; // 'left' o 'right'

        // ========== FUNZIONI UI/NAVIGAZIONE ==========
        function showScreen(screen) {
            [modeMenu, multiplayerMenu, hostScreen, joinScreen, gameScreen].forEach(s => {
                s.classList.add('hidden');
            });
            screen.classList.remove('hidden');
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // ========== GESTIONE MENU ==========
        vsAIBtn.addEventListener('click', () => {
            gameMode = 'ai';
            myPaddleSide = 'right';
            gameInstructions.textContent = 'Muovi il mouse su e giù per controllare la racchetta destra';
            showScreen(gameScreen);
            draw();
        });

        vsPlayerBtn.addEventListener('click', () => {
            showScreen(multiplayerMenu);
        });

        backFromMulti.addEventListener('click', () => {
            showScreen(modeMenu);
        });

        hostBtn.addEventListener('click', () => {
            setupHost();
        });

        joinBtn.addEventListener('click', () => {
            showScreen(joinScreen);
        });

        backFromHost.addEventListener('click', () => {
            if (peer) peer.destroy();
            showScreen(multiplayerMenu);
        });

        backFromJoin.addEventListener('click', () => {
            showScreen(multiplayerMenu);
        });

        connectBtn.addEventListener('click', () => {
            const code = codeInput.value.trim().toUpperCase();
            if (code.length >= 4) {
                joinGame(code);
            } else {
                joinStatus.textContent = 'Inserisci un codice valido';
            }
        });

        // ========== P2P CONNECTION ==========
        function setupHost() {
            gameMode = 'multiplayer';
            isHost = true;
            myPaddleSide = 'left';

            const roomCode = generateRoomCode();
            peer = new Peer('pong-' + roomCode);

            peer.on('open', (id) => {
                roomCodeEl.textContent = roomCode;
                hostStatus.textContent = 'In attesa dell\'altro giocatore...';
                showScreen(hostScreen);
            });

            peer.on('connection', (conn) => {
                connection = conn;
                setupConnection();
                hostStatus.textContent = 'Giocatore connesso! Inizia quando sei pronto.';

                setTimeout(() => {
                    gameInstructions.textContent = 'Muovi il mouse su e giù per controllare la racchetta SINISTRA';
                    showScreen(gameScreen);
                    draw();
                }, 1000);
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                hostStatus.textContent = 'Errore di connessione. Riprova.';
            });
        }

        function joinGame(roomCode) {
            gameMode = 'multiplayer';
            isHost = false;
            myPaddleSide = 'right';

            joinStatus.textContent = 'Connessione in corso...';

            peer = new Peer();

            peer.on('open', () => {
                connection = peer.connect('pong-' + roomCode);

                connection.on('open', () => {
                    setupConnection();
                    joinStatus.textContent = 'Connesso! Inizia quando sei pronto.';

                    setTimeout(() => {
                        gameInstructions.textContent = 'Muovi il mouse su e giù per controllare la racchetta DESTRA';
                        showScreen(gameScreen);
                        draw();
                    }, 1000);
                });

                connection.on('error', (err) => {
                    console.error('Connection error:', err);
                    joinStatus.textContent = 'Impossibile connettersi. Verifica il codice.';
                });
            });
        }

        function setupConnection() {
            connection.on('data', (data) => {
                handlePeerData(data);
            });

            connection.on('close', () => {
                alert('L\'altro giocatore si è disconnesso.');
                location.reload();
            });
        }

        function sendToPeer(data) {
            if (connection && connection.open) {
                connection.send(data);
            }
        }

        function handlePeerData(data) {
            switch(data.type) {
                case 'paddle':
                    // Aggiorna la posizione della racchetta dell'avversario
                    if (myPaddleSide === 'left') {
                        paddleRight.y = data.y;
                    } else {
                        paddleLeft.y = data.y;
                    }
                    break;
                case 'start':
                    // L'altro giocatore ha iniziato
                    if (!gameRunning) {
                        gameRunning = true;
                        startBtn.disabled = true;
                        startBtn.textContent = 'IN GIOCO...';
                        playWhistle();
                        resetBall();
                        gameLoop();
                    }
                    break;
                case 'ball':
                    // Sincronizza la palla (solo l'host invia questo)
                    if (!isHost) {
                        ball.x = data.x;
                        ball.y = data.y;
                        ball.speedX = data.speedX;
                        ball.speedY = data.speedY;
                    }
                    break;
                case 'score':
                    // Sincronizza il punteggio
                    scoreLeft = data.left;
                    scoreRight = data.right;
                    scoreLeftEl.textContent = scoreLeft;
                    scoreRightEl.textContent = scoreRight;
                    break;
            }
        }

        // ========== FUNZIONI AUDIO ==========
        // Funzione per suonare il fischietto (inizio gioco)
        function playWhistle() {
            whistleSound.currentTime = 0;
            whistleSound.play();
        }

        // Funzione per suonare il pong (colpo sulla racchetta)
        function playPong() {
            pongSound.currentTime = 0;
            pongSound.play();
        }

        // Funzione per suonare la tromba (punto fatto)
        function playTrumpet() {
            trumpetSound.currentTime = 0;
            trumpetSound.play();
        }

        // Funzione per la celebrazione con i coriandoli
        function celebrate() {
            const duration = 3000; // 3 secondi di coriandoli
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);

                // Lancia i coriandoli da posizioni casuali
                confetti({
                    ...defaults,
                    particleCount,
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
                });
                confetti({
                    ...defaults,
                    particleCount,
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
                });
            }, 250);
        }

        // Funzione per controllare se c'è un vincitore
        function checkWinner() {
            if (scoreLeft >= POINTS_TO_WIN) {
                let winnerName = gameMode === 'ai' ? 'AI' :
                                 (myPaddleSide === 'left' ? 'TU' : 'AVVERSARIO');
                endGame(winnerName);
                return true;
            } else if (scoreRight >= POINTS_TO_WIN) {
                let winnerName = gameMode === 'ai' ? 'GIOCATORE' :
                                 (myPaddleSide === 'right' ? 'TU' : 'AVVERSARIO');
                endGame(winnerName);
                return true;
            }
            return false;
        }

        // Funzione per terminare il gioco
        function endGame(winner) {
            gameRunning = false;
            startBtn.disabled = false;
            startBtn.textContent = `${winner} HA VINTO! CLICCA PER RIGIOCARE`;
            celebrate();

            // Reset dei punteggi per la prossima partita
            setTimeout(() => {
                scoreLeft = 0;
                scoreRight = 0;
                scoreLeftEl.textContent = scoreLeft;
                scoreRightEl.textContent = scoreRight;
                startBtn.textContent = 'INIZIA';
                resetBall();
                draw();
            }, 4000);
        }

        // Colori
        const COLORS = {
            background: '#0f0f23',
            paddle: '#ffffff',
            ball: '#ffffff',
            centerLine: '#2a2a4a'
        };

        // Configurazione gioco
        const PADDLE_WIDTH = 12;
        const PADDLE_HEIGHT = 100;
        const BALL_SIZE = 14;
        const PADDLE_SPEED = 5;
        const INITIAL_BALL_SPEED = 6;
        const POINTS_TO_WIN = 3; // Punti necessari per vincere

        // Stato del gioco
        let gameRunning = false;
        let scoreLeft = 0;
        let scoreRight = 0;

        // Racchetta sinistra (AI)
        const paddleLeft = {
            x: 30,
            y: canvas.height / 2 - PADDLE_HEIGHT / 2,
            width: PADDLE_WIDTH,
            height: PADDLE_HEIGHT,
            speed: PADDLE_SPEED * 0.85 // Leggermente più lenta per dare chance al giocatore
        };

        // Racchetta destra (Giocatore)
        const paddleRight = {
            x: canvas.width - 30 - PADDLE_WIDTH,
            y: canvas.height / 2 - PADDLE_HEIGHT / 2,
            width: PADDLE_WIDTH,
            height: PADDLE_HEIGHT
        };

        // Palla
        const ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            size: BALL_SIZE,
            speedX: INITIAL_BALL_SPEED,
            speedY: INITIAL_BALL_SPEED * 0.5,
            baseSpeed: INITIAL_BALL_SPEED
        };

        // Target Y per l'AI (con un po' di ritardo nella reazione)
        let aiTargetY = canvas.height / 2;

        // Movimento mouse
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseY = e.clientY - rect.top;

            // Determina quale racchetta controllare
            let paddle = myPaddleSide === 'right' ? paddleRight : paddleLeft;

            // Centra la racchetta sul mouse
            paddle.y = mouseY - PADDLE_HEIGHT / 2;

            // Limita ai bordi
            if (paddle.y < 0) paddle.y = 0;
            if (paddle.y + PADDLE_HEIGHT > canvas.height) {
                paddle.y = canvas.height - PADDLE_HEIGHT;
            }

            // Invia la posizione al peer in modalità multiplayer
            if (gameMode === 'multiplayer') {
                sendToPeer({ type: 'paddle', y: paddle.y });
            }
        });

        // Avvia il gioco
        startBtn.addEventListener('click', () => {
            if (!gameRunning) {
                gameRunning = true;
                startBtn.disabled = true;
                startBtn.textContent = 'IN GIOCO...';
                playWhistle(); // Fischietto di inizio
                resetBall();

                // Notifica l'altro giocatore in modalità multiplayer
                if (gameMode === 'multiplayer') {
                    sendToPeer({ type: 'start' });
                }

                gameLoop();
            }
        });

        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            
            // Direzione casuale
            ball.speedX = (Math.random() > 0.5 ? 1 : -1) * ball.baseSpeed;
            ball.speedY = (Math.random() - 0.5) * ball.baseSpeed;
        }

        function updateAI() {
            // L'AI è attiva solo in modalità vs computer
            if (gameMode !== 'ai') return;

            // L'AI insegue la palla con un po' di ritardo
            if (ball.speedX < 0) { // La palla viene verso l'AI
                aiTargetY = ball.y;
            } else {
                // Quando la palla va via, torna al centro
                aiTargetY = canvas.height / 2;
            }

            const paddleCenter = paddleLeft.y + PADDLE_HEIGHT / 2;
            const diff = aiTargetY - paddleCenter;

            // Muovi verso il target con velocità limitata
            if (Math.abs(diff) > paddleLeft.speed) {
                paddleLeft.y += diff > 0 ? paddleLeft.speed : -paddleLeft.speed;
            }

            // Limita ai bordi
            if (paddleLeft.y < 0) paddleLeft.y = 0;
            if (paddleLeft.y + PADDLE_HEIGHT > canvas.height) {
                paddleLeft.y = canvas.height - PADDLE_HEIGHT;
            }
        }

        function updateBall() {
            // In multiplayer, solo l'host calcola la fisica della palla
            if (gameMode === 'multiplayer' && !isHost) {
                return; // Il client riceve gli aggiornamenti dal peer
            }

            ball.x += ball.speedX;
            ball.y += ball.speedY;

            // Rimbalzo sui bordi superiore e inferiore
            if (ball.y - ball.size / 2 <= 0 || ball.y + ball.size / 2 >= canvas.height) {
                ball.speedY = -ball.speedY;
                ball.y = ball.y - ball.size / 2 <= 0 ? ball.size / 2 : canvas.height - ball.size / 2;
            }

            // Collisione con racchetta sinistra
            if (ball.x - ball.size / 2 <= paddleLeft.x + paddleLeft.width &&
                ball.x + ball.size / 2 >= paddleLeft.x &&
                ball.y >= paddleLeft.y &&
                ball.y <= paddleLeft.y + paddleLeft.height) {

                playPong(); // Suono quando colpisce la racchetta
                ball.speedX = Math.abs(ball.speedX) * 1.05; // Accelera leggermente

                // Angolo basato su dove colpisce la racchetta
                const hitPos = (ball.y - paddleLeft.y) / PADDLE_HEIGHT;
                ball.speedY = (hitPos - 0.5) * ball.baseSpeed * 2;

                ball.x = paddleLeft.x + paddleLeft.width + ball.size / 2;
            }

            // Collisione con racchetta destra
            if (ball.x + ball.size / 2 >= paddleRight.x &&
                ball.x - ball.size / 2 <= paddleRight.x + paddleRight.width &&
                ball.y >= paddleRight.y &&
                ball.y <= paddleRight.y + paddleRight.height) {

                playPong(); // Suono quando colpisce la racchetta
                ball.speedX = -Math.abs(ball.speedX) * 1.05; // Accelera leggermente

                // Angolo basato su dove colpisce la racchetta
                const hitPos = (ball.y - paddleRight.y) / PADDLE_HEIGHT;
                ball.speedY = (hitPos - 0.5) * ball.baseSpeed * 2;

                ball.x = paddleRight.x - ball.size / 2;
            }

            // Punto segnato
            if (ball.x < 0) {
                playTrumpet(); // Suono della tromba per punto fatto
                scoreRight++;
                scoreRightEl.textContent = scoreRight;

                // Sincronizza il punteggio in multiplayer
                if (gameMode === 'multiplayer') {
                    sendToPeer({ type: 'score', left: scoreLeft, right: scoreRight });
                }

                if (!checkWinner()) {
                    resetBall();
                }
            } else if (ball.x > canvas.width) {
                playTrumpet(); // Suono della tromba per punto fatto
                scoreLeft++;
                scoreLeftEl.textContent = scoreLeft;

                // Sincronizza il punteggio in multiplayer
                if (gameMode === 'multiplayer') {
                    sendToPeer({ type: 'score', left: scoreLeft, right: scoreRight });
                }

                if (!checkWinner()) {
                    resetBall();
                }
            }

            // Sincronizza la posizione della palla in multiplayer (solo host)
            if (gameMode === 'multiplayer' && isHost) {
                sendToPeer({
                    type: 'ball',
                    x: ball.x,
                    y: ball.y,
                    speedX: ball.speedX,
                    speedY: ball.speedY
                });
            }
        }

        function draw() {
            // Sfondo
            ctx.fillStyle = COLORS.background;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Linea centrale tratteggiata
            ctx.strokeStyle = COLORS.centerLine;
            ctx.lineWidth = 4;
            ctx.setLineDash([20, 15]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);

            // Racchetta sinistra
            ctx.fillStyle = COLORS.paddle;
            ctx.fillRect(paddleLeft.x, paddleLeft.y, paddleLeft.width, paddleLeft.height);

            // Racchetta destra
            ctx.fillRect(paddleRight.x, paddleRight.y, paddleRight.width, paddleRight.height);

            // Palla
            ctx.fillStyle = COLORS.ball;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.size / 2, 0, Math.PI * 2);
            ctx.fill();
        }

        function gameLoop() {
            if (!gameRunning) return;

            updateAI();
            updateBall();
            draw();

            requestAnimationFrame(gameLoop);
        }

        // Disegna lo stato iniziale
        draw();
    </script>
</body>
</html>