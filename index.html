<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #1a1a2e;
            font-family: 'Courier New', monospace;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #scoreboard {
            display: flex;
            gap: 60px;
            font-size: 48px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .score {
            min-width: 60px;
            text-align: center;
        }

        #gameCanvas {
            border: 4px solid #4a4a6a;
            border-radius: 8px;
            cursor: none;
        }

        #startBtn {
            padding: 15px 40px;
            font-size: 20px;
            font-family: 'Courier New', monospace;
            background: #16213e;
            color: #fff;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #startBtn:hover {
            background: #1f4068;
            border-color: #7a7aaa;
            transform: scale(1.05);
        }

        #startBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .instructions {
            color: #6a6a8a;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="scoreboard">
            <span class="score" id="scoreLeft">0</span>
            <span>-</span>
            <span class="score" id="scoreRight">0</span>
        </div>
        <canvas id="gameCanvas" width="800" height="500"></canvas>
        <button id="startBtn">INIZIA</button>
        <p class="instructions">Muovi il mouse su e giù per controllare la racchetta destra</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const scoreLeftEl = document.getElementById('scoreLeft');
        const scoreRightEl = document.getElementById('scoreRight');

        // Carica i suoni dalla cartella sound
        const whistleSound = new Audio('sound/whistle.mp3');
        const pongSound = new Audio('sound/pong.mp3');
        const trumpetSound = new Audio('sound/trumpet.mp3');

        // Funzione per suonare il fischietto (inizio gioco)
        function playWhistle() {
            whistleSound.currentTime = 0;
            whistleSound.play();
        }

        // Funzione per suonare il pong (colpo sulla racchetta)
        function playPong() {
            pongSound.currentTime = 0;
            pongSound.play();
        }

        // Funzione per suonare la tromba (punto fatto)
        function playTrumpet() {
            trumpetSound.currentTime = 0;
            trumpetSound.play();
        }

        // Funzione per la celebrazione con i coriandoli
        function celebrate() {
            const duration = 3000; // 3 secondi di coriandoli
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);

                // Lancia i coriandoli da posizioni casuali
                confetti({
                    ...defaults,
                    particleCount,
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
                });
                confetti({
                    ...defaults,
                    particleCount,
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
                });
            }, 250);
        }

        // Funzione per controllare se c'è un vincitore
        function checkWinner() {
            if (scoreLeft >= POINTS_TO_WIN) {
                endGame('AI');
                return true;
            } else if (scoreRight >= POINTS_TO_WIN) {
                endGame('GIOCATORE');
                return true;
            }
            return false;
        }

        // Funzione per terminare il gioco
        function endGame(winner) {
            gameRunning = false;
            startBtn.disabled = false;
            startBtn.textContent = `${winner} HA VINTO! CLICCA PER RIGIOCARE`;
            celebrate();

            // Reset dei punteggi per la prossima partita
            setTimeout(() => {
                scoreLeft = 0;
                scoreRight = 0;
                scoreLeftEl.textContent = scoreLeft;
                scoreRightEl.textContent = scoreRight;
                startBtn.textContent = 'INIZIA';
                resetBall();
                draw();
            }, 4000);
        }

        // Colori
        const COLORS = {
            background: '#0f0f23',
            paddle: '#ffffff',
            ball: '#ffffff',
            centerLine: '#2a2a4a'
        };

        // Configurazione gioco
        const PADDLE_WIDTH = 12;
        const PADDLE_HEIGHT = 100;
        const BALL_SIZE = 14;
        const PADDLE_SPEED = 5;
        const INITIAL_BALL_SPEED = 6;
        const POINTS_TO_WIN = 3; // Punti necessari per vincere

        // Stato del gioco
        let gameRunning = false;
        let scoreLeft = 0;
        let scoreRight = 0;

        // Racchetta sinistra (AI)
        const paddleLeft = {
            x: 30,
            y: canvas.height / 2 - PADDLE_HEIGHT / 2,
            width: PADDLE_WIDTH,
            height: PADDLE_HEIGHT,
            speed: PADDLE_SPEED * 0.85 // Leggermente più lenta per dare chance al giocatore
        };

        // Racchetta destra (Giocatore)
        const paddleRight = {
            x: canvas.width - 30 - PADDLE_WIDTH,
            y: canvas.height / 2 - PADDLE_HEIGHT / 2,
            width: PADDLE_WIDTH,
            height: PADDLE_HEIGHT
        };

        // Palla
        const ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            size: BALL_SIZE,
            speedX: INITIAL_BALL_SPEED,
            speedY: INITIAL_BALL_SPEED * 0.5,
            baseSpeed: INITIAL_BALL_SPEED
        };

        // Target Y per l'AI (con un po' di ritardo nella reazione)
        let aiTargetY = canvas.height / 2;

        // Movimento mouse
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseY = e.clientY - rect.top;
            
            // Centra la racchetta sul mouse
            paddleRight.y = mouseY - PADDLE_HEIGHT / 2;
            
            // Limita ai bordi
            if (paddleRight.y < 0) paddleRight.y = 0;
            if (paddleRight.y + PADDLE_HEIGHT > canvas.height) {
                paddleRight.y = canvas.height - PADDLE_HEIGHT;
            }
        });

        // Avvia il gioco
        startBtn.addEventListener('click', () => {
            if (!gameRunning) {
                gameRunning = true;
                startBtn.disabled = true;
                startBtn.textContent = 'IN GIOCO...';
                playWhistle(); // Fischietto di inizio
                resetBall();
                gameLoop();
            }
        });

        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            
            // Direzione casuale
            ball.speedX = (Math.random() > 0.5 ? 1 : -1) * ball.baseSpeed;
            ball.speedY = (Math.random() - 0.5) * ball.baseSpeed;
        }

        function updateAI() {
            // L'AI insegue la palla con un po' di ritardo
            if (ball.speedX < 0) { // La palla viene verso l'AI
                aiTargetY = ball.y;
            } else {
                // Quando la palla va via, torna al centro
                aiTargetY = canvas.height / 2;
            }

            const paddleCenter = paddleLeft.y + PADDLE_HEIGHT / 2;
            const diff = aiTargetY - paddleCenter;

            // Muovi verso il target con velocità limitata
            if (Math.abs(diff) > paddleLeft.speed) {
                paddleLeft.y += diff > 0 ? paddleLeft.speed : -paddleLeft.speed;
            }

            // Limita ai bordi
            if (paddleLeft.y < 0) paddleLeft.y = 0;
            if (paddleLeft.y + PADDLE_HEIGHT > canvas.height) {
                paddleLeft.y = canvas.height - PADDLE_HEIGHT;
            }
        }

        function updateBall() {
            ball.x += ball.speedX;
            ball.y += ball.speedY;

            // Rimbalzo sui bordi superiore e inferiore
            if (ball.y - ball.size / 2 <= 0 || ball.y + ball.size / 2 >= canvas.height) {
                ball.speedY = -ball.speedY;
                ball.y = ball.y - ball.size / 2 <= 0 ? ball.size / 2 : canvas.height - ball.size / 2;
            }

            // Collisione con racchetta sinistra
            if (ball.x - ball.size / 2 <= paddleLeft.x + paddleLeft.width &&
                ball.x + ball.size / 2 >= paddleLeft.x &&
                ball.y >= paddleLeft.y &&
                ball.y <= paddleLeft.y + paddleLeft.height) {

                playPong(); // Suono quando colpisce la racchetta
                ball.speedX = Math.abs(ball.speedX) * 1.05; // Accelera leggermente

                // Angolo basato su dove colpisce la racchetta
                const hitPos = (ball.y - paddleLeft.y) / PADDLE_HEIGHT;
                ball.speedY = (hitPos - 0.5) * ball.baseSpeed * 2;

                ball.x = paddleLeft.x + paddleLeft.width + ball.size / 2;
            }

            // Collisione con racchetta destra
            if (ball.x + ball.size / 2 >= paddleRight.x &&
                ball.x - ball.size / 2 <= paddleRight.x + paddleRight.width &&
                ball.y >= paddleRight.y &&
                ball.y <= paddleRight.y + paddleRight.height) {

                playPong(); // Suono quando colpisce la racchetta
                ball.speedX = -Math.abs(ball.speedX) * 1.05; // Accelera leggermente

                // Angolo basato su dove colpisce la racchetta
                const hitPos = (ball.y - paddleRight.y) / PADDLE_HEIGHT;
                ball.speedY = (hitPos - 0.5) * ball.baseSpeed * 2;

                ball.x = paddleRight.x - ball.size / 2;
            }

            // Punto segnato
            if (ball.x < 0) {
                playTrumpet(); // Suono della tromba per punto fatto
                scoreRight++;
                scoreRightEl.textContent = scoreRight;
                if (!checkWinner()) {
                    resetBall();
                }
            } else if (ball.x > canvas.width) {
                playTrumpet(); // Suono della tromba per punto fatto
                scoreLeft++;
                scoreLeftEl.textContent = scoreLeft;
                if (!checkWinner()) {
                    resetBall();
                }
            }
        }

        function draw() {
            // Sfondo
            ctx.fillStyle = COLORS.background;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Linea centrale tratteggiata
            ctx.strokeStyle = COLORS.centerLine;
            ctx.lineWidth = 4;
            ctx.setLineDash([20, 15]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);

            // Racchetta sinistra
            ctx.fillStyle = COLORS.paddle;
            ctx.fillRect(paddleLeft.x, paddleLeft.y, paddleLeft.width, paddleLeft.height);

            // Racchetta destra
            ctx.fillRect(paddleRight.x, paddleRight.y, paddleRight.width, paddleRight.height);

            // Palla
            ctx.fillStyle = COLORS.ball;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.size / 2, 0, Math.PI * 2);
            ctx.fill();
        }

        function gameLoop() {
            if (!gameRunning) return;

            updateAI();
            updateBall();
            draw();

            requestAnimationFrame(gameLoop);
        }

        // Disegna lo stato iniziale
        draw();
    </script>
</body>
</html>